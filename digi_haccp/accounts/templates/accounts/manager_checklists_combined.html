{% extends "accounts/nav_bar.html" %}

{% block title %}Checklists | Digi HACCP{% endblock %}

{% block extra_head %}

<!-- (UI Frameworks)
     I imported DaisyUI + Tailwind for easy button and layout styling.
     This keeps the entire checklist UI consistent with the rest of the site. -->
<link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.css" rel="stylesheet" />
<script>document.documentElement.setAttribute('data-theme', 'pastel');</script>

<!-- (AG Grid)
     I included AG Grid here since this page displays dynamic table data.
     The Alpine theme gives it a clean spreadsheet-like look. -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" />
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>

<style>

  /* (Background Styling)
     I kept the same green gradient theme to match the rest of the HACCP system. */
  body {
    background: linear-gradient(135deg, #a8e063, #56ab2f);
    font-family: "Poppins", sans-serif;
    margin: 0;
    padding-bottom: 40px;
  }

  /* (Navbar)
     This navbar style matches all other pages so the layout feels unified. */
  .navbar {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(8px);
    padding: 18px 40px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
  }

  /* (Content Card)
     I wrapped everything in a centered card so the page doesn't stretch too wide. */
  .card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    padding: 30px;
    margin: 40px auto;
    max-width: 1200px;
  }

  /* (Table Styles)
     Basic clean table layout so managers can quickly scan through checklists. */
  table {
    width: 100%;
    margin-bottom: 20px;
  }

  th, td {
    padding: 12px;
    border-bottom: 1px solid #eee;
  }

  th {
    background: #f7f7f7;
    font-weight: 700;
  }
</style>

{% endblock %}

{% block content %}

<!-- (Main Content Card)
     This card holds the full list of all checklists created for all delis. -->
<div class="card">

  <!-- (Page Title) -->
  <h2 class="text-3xl font-bold mb-6 text-center">Checklists</h2>

  <!-- (Create Checklist Button)
       I added this so managers can quickly create new checklists from this page. -->
  <div class="flex justify-end mb-4" style="padding-top: 10px; padding-bottom: 10px;">
      <a href="{% url 'create_checklist' %}" 
      class="btn btn-warning px-6 py-2 font-semibold">
          + Create Checklist
      </a>
  </div>

  <!-- (Checklist List Table)
       This table shows all checklists the manager has access to:
       - Title
       - Deli it belongs to
       - Template used
       - Frequency
       - Date created
       - A button to view the data -->
  <table>
      <thead>
          <tr>
              <th>Title</th>
              <th>Deli</th>
              <th>Template</th>
              <th>Frequency</th>
              <th>Status</th>
              <th>Created</th>
              <th>Select</th>
              <th>Actions</th>
          </tr>
      </thead>

      <tbody>
          {% for c in checklists %}
          <tr>
              <td>{{ c.title }}</td>
              <td>{{ c.deli.deli_name }}</td>
              <td>{{ c.template.name }}</td>
              <td>{{ c.frequency|title }}</td>
              <td>
                {% if c.is_active %}
                  <span class="badge badge-success">Active</span>
                {% else %}
                  <span class="badge badge-ghost">Unassigned</span>
                {% endif %}
              </td>
              <td>{{ c.created_at|date:"d M Y, H:i" }}</td>

              <!-- (View Button)
                   When clicked it loads this checklist's data into the AG Grid below. -->
              <td>
                  <button onclick="loadChecklist({{ c.id }})"
                          class="btn btn-accent btn-sm">View</button>
              </td>

              <td>
                <div class="flex gap-2">
                  {% if c.is_active %}
                  <form method="post" action="{% url 'manager_unassign_checklist' c.id %}">
                    {% csrf_token %}
                    <button
                      type="submit"
                      class="btn btn-warning btn-sm"
                      onclick="return confirm('Unassign this checklist? Staff will no longer see it.')"
                    >
                      Unassign
                    </button>
                  </form>
                  {% else %}
                  <form method="post" action="{% url 'manager_assign_checklist' c.id %}">
                    {% csrf_token %}
                    <button
                      type="submit"
                      class="btn btn-success btn-sm"
                      onclick="return confirm('Assign this checklist? Staff will see it as active again.')"
                    >
                      Assign
                    </button>
                  </form>
                  {% endif %}

                  <form method="post" action="{% url 'manager_delete_checklist' c.id %}">
                    {% csrf_token %}
                    <button
                      type="submit"
                      class="btn btn-error btn-sm"
                      onclick="return confirm('Delete this checklist permanently? This will remove related checklist history.')"
                    >
                      Delete
                    </button>
                  </form>
                </div>
              </td>
          </tr>
          {% endfor %}
      </tbody>
  </table>

  <hr class="my-6">

  <!-- (Selected Checklist Title)
       When the user clicks "View", I update this heading dynamically. -->
  <h3 id="detailTitle" class="text-xl font-bold mb-4"></h3>

  <!-- (AG Grid Container)
       This is where all the dynamic checklist questions + columns are displayed. -->
  <div id="myGrid" class="ag-theme-alpine" style="height: 500px; width: 100%;"></div>

</div>

<!-- (JavaScript: Load Selected Checklist)
     When a manager clicks the "View" button I make a fetch call to the API endpoint
     and build the AG Grid with the returned JSON data. -->
<script>
function loadChecklist(id) {
    fetch(`/api/checklists/${id}/`)
    .then(res => res.json())
    .then(data => {

        // Update header with selected checklist name
        document.getElementById("detailTitle").innerText =
            `${data.title} â€” ${data.deli} (${data.template})`;

        // Clear previous grid content
        document.getElementById("myGrid").innerHTML = "";

        // (Create AG Grid)
        // I pass in the column definitions + row data sent from Django.
        agGrid.createGrid(document.getElementById("myGrid"), {
            columnDefs: data.columnDefs,
            rowData: data.rowData,
            pagination: true,
            paginationPageSize: 20,
            defaultColDef: {
                sortable: true,
                filter: true,
                resizable: true
            }
        });
    });
}
</script>

{% endblock %}
